(function(){var require=function(file,cwd){var resolved=require.resolve(file,cwd||"/");var mod=require.modules[resolved];if(!mod)throw new Error("Failed to resolve module "+file+", tried "+resolved);var cached=require.cache[resolved];var res=cached?cached.exports:mod();return res};require.paths=[];require.modules={};require.cache={};require.extensions=[".js",".coffee",".json"];require._core={assert:true,events:true,fs:true,path:true,vm:true};require.resolve=function(){return function(x,cwd){if(!cwd)cwd="/";if(require._core[x])return x;var path=require.modules.path();cwd=path.resolve("/",cwd);var y=cwd||"/";if(x.match(/^(?:\.\.?\/|\/)/)){var m=loadAsFileSync(path.resolve(y,x))||loadAsDirectorySync(path.resolve(y,x));if(m)return m}var n=loadNodeModulesSync(x,y);if(n)return n;throw new Error("Cannot find module '"+x+"'");function loadAsFileSync(x){x=path.normalize(x);if(require.modules[x]){return x}for(var i=0;i<require.extensions.length;i++){var ext=require.extensions[i];if(require.modules[x+ext])return x+ext}}function loadAsDirectorySync(x){x=x.replace(/\/+$/,"");var pkgfile=path.normalize(x+"/package.json");if(require.modules[pkgfile]){var pkg=require.modules[pkgfile]();var b=pkg.browserify;if(typeof b==="object"&&b.main){var m=loadAsFileSync(path.resolve(x,b.main));if(m)return m}else if(typeof b==="string"){var m=loadAsFileSync(path.resolve(x,b));if(m)return m}else if(pkg.main){var m=loadAsFileSync(path.resolve(x,pkg.main));if(m)return m}}return loadAsFileSync(x+"/index")}function loadNodeModulesSync(x,start){var dirs=nodeModulesPathsSync(start);for(var i=0;i<dirs.length;i++){var dir=dirs[i];var m=loadAsFileSync(dir+"/"+x);if(m)return m;var n=loadAsDirectorySync(dir+"/"+x);if(n)return n}var m=loadAsFileSync(x);if(m)return m}function nodeModulesPathsSync(start){var parts;if(start==="/")parts=[""];else parts=path.normalize(start).split("/");var dirs=[];for(var i=parts.length-1;i>=0;i--){if(parts[i]==="node_modules")continue;var dir=parts.slice(0,i+1).join("/")+"/node_modules";dirs.push(dir)}return dirs}}}();require.alias=function(from,to){var path=require.modules.path();var res=null;try{res=require.resolve(from+"/package.json","/")}catch(err){res=require.resolve(from,"/")}var basedir=path.dirname(res);var keys=(Object.keys||function(obj){var res=[];for(var key in obj)res.push(key);return res})(require.modules);for(var i=0;i<keys.length;i++){var key=keys[i];if(key.slice(0,basedir.length+1)===basedir+"/"){var f=key.slice(basedir.length);require.modules[to+f]=require.modules[basedir+f]}else if(key===basedir){require.modules[to]=require.modules[basedir]}}};(function(){var process={};var global=typeof window!=="undefined"?window:{};var definedProcess=false;require.define=function(filename,fn){if(!definedProcess&&require.modules.__browserify_process){process=require.modules.__browserify_process();definedProcess=true}var dirname=require._core[filename]?"":require.modules.path().dirname(filename);var require_=function(file){var requiredModule=require(file,dirname);var cached=require.cache[require.resolve(file,dirname)];if(cached&&cached.parent===null){cached.parent=module_}return requiredModule};require_.resolve=function(name){return require.resolve(name,dirname)};require_.modules=require.modules;require_.define=require.define;require_.cache=require.cache;var module_={id:filename,filename:filename,exports:{},loaded:false,parent:null};require.modules[filename]=function(){require.cache[filename]=module_;fn.call(module_.exports,require_,module_,module_.exports,dirname,filename,process,global);module_.loaded=true;return module_.exports}}})();require.define("path",function(require,module,exports,__dirname,__filename,process,global){function filter(xs,fn){var res=[];for(var i=0;i<xs.length;i++){if(fn(xs[i],i,xs))res.push(xs[i])}return res}function normalizeArray(parts,allowAboveRoot){var up=0;for(var i=parts.length;i>=0;i--){var last=parts[i];if(last=="."){parts.splice(i,1)}else if(last===".."){parts.splice(i,1);up++}else if(up){parts.splice(i,1);up--}}if(allowAboveRoot){for(;up--;up){parts.unshift("..")}}return parts}var splitPathRe=/^(.+\/(?!$)|\/)?((?:.+?)?(\.[^.]*)?)$/;exports.resolve=function(){var resolvedPath="",resolvedAbsolute=false;for(var i=arguments.length;i>=-1&&!resolvedAbsolute;i--){var path=i>=0?arguments[i]:process.cwd();if(typeof path!=="string"||!path){continue}resolvedPath=path+"/"+resolvedPath;resolvedAbsolute=path.charAt(0)==="/"}resolvedPath=normalizeArray(filter(resolvedPath.split("/"),function(p){return!!p}),!resolvedAbsolute).join("/");return(resolvedAbsolute?"/":"")+resolvedPath||"."};exports.normalize=function(path){var isAbsolute=path.charAt(0)==="/",trailingSlash=path.slice(-1)==="/";path=normalizeArray(filter(path.split("/"),function(p){return!!p}),!isAbsolute).join("/");if(!path&&!isAbsolute){path="."}if(path&&trailingSlash){path+="/"}return(isAbsolute?"/":"")+path};exports.join=function(){var paths=Array.prototype.slice.call(arguments,0);return exports.normalize(filter(paths,function(p,index){return p&&typeof p==="string"}).join("/"))};exports.dirname=function(path){var dir=splitPathRe.exec(path)[1]||"";var isWindows=false;if(!dir){return"."}else if(dir.length===1||isWindows&&dir.length<=3&&dir.charAt(1)===":"){return dir}else{return dir.substring(0,dir.length-1)}};exports.basename=function(path,ext){var f=splitPathRe.exec(path)[2]||"";if(ext&&f.substr(-1*ext.length)===ext){f=f.substr(0,f.length-ext.length)}return f};exports.extname=function(path){return splitPathRe.exec(path)[3]||""}});require.define("__browserify_process",function(require,module,exports,__dirname,__filename,process,global){var process=module.exports={};process.nextTick=function(){var canSetImmediate=typeof window!=="undefined"&&window.setImmediate;var canPost=typeof window!=="undefined"&&window.postMessage&&window.addEventListener;if(canSetImmediate){return function(f){return window.setImmediate(f)}}if(canPost){var queue=[];window.addEventListener("message",function(ev){if(ev.source===window&&ev.data==="browserify-tick"){ev.stopPropagation();if(queue.length>0){var fn=queue.shift();fn()}}},true);return function nextTick(fn){queue.push(fn);window.postMessage("browserify-tick","*")}}return function nextTick(fn){setTimeout(fn,0)}}();process.title="browser";process.browser=true;process.env={};process.argv=[];process.binding=function(name){if(name==="evals")return require("vm");else throw new Error("No such module. (Possibly not yet loaded)")};(function(){var cwd="/";var path;process.cwd=function(){return cwd};process.chdir=function(dir){if(!path)path=require("path");cwd=path.resolve(dir,cwd)}})()});require.define("/lib/index.js",function(require,module,exports,__dirname,__filename,process,global){var fs=require("fs");var path=require("path");var runtime=exports.runtime=require("./runtime/core");var define=exports.define=require("./compiler/define");var parser=exports.parser=require("./compiler/parser");if(typeof window==="undefined"){var isBrowser=false}else{var isBrowser=true}var isNode=!isBrowser;if(isNode&&/bright/gim.test(process.env.DEBUG)||isBrowser&&typeof _BRIGHT_DEBUG!=="undefined"){var debug=console.log}else{var debug=function(){}}exports.compile=function(source){var $$_runtime=runtime;var $$_javascript=parser.parse(source);debug($$_javascript);return eval($$_javascript)};if(isNode){require.extensions[".bright"]=function(module,filename){module.exports=exports.load(filename)};exports.load=function(filename){var source=fs.readFileSync(filename,"utf8");var js=parser.parse(source);js='var $$_runtime = require("bright").runtime;\n'+js+"(function (err) {\n"+"  if (err) console.error(err && err.stack);\n"+"});";var target=filename+".compile.js";fs.writeFileSync(target,js);return require(target)}}else{if(typeof window.Bright==="undefined"){window.Bright=module.exports}else{console.error('Cannot register namespace "Bright".')}var run=function(source){var fn=exports.compile(source);fn(function(err){if(err)console.error(err&&err.stack)})};exports.load=function(url,callback){var xhr=window.ActiveXObject?new window.ActiveXObject("Microsoft.XMLHTTP"):new XMLHttpRequest;xhr.open("GET",url,true);if("overrideMimeType"in xhr){xhr.overrideMimeType("text/plain")}xhr.onreadystatechange=function(){var _ref;if(xhr.readyState===4){if((_ref=xhr.status)===0||_ref===200){run(xhr.responseText)}else{throw new Error("Could not load "+url)}if(callback){return callback()}}};return xhr.send(null)};var runScripts=function(){var scripts=document.getElementsByTagName("script");for(var i=0,len=scripts.length;i<len;i++){var s=scripts[i];if(s&&s.type&&s.type==="text/bright"){if(s.src){exports.load(s.src)}else{run(s.innerHTML)}}}};if(window.addEventListener){addEventListener("DOMContentLoaded",runScripts,false)}else{attachEvent("onload",runScripts)}}});require.define("fs",function(require,module,exports,__dirname,__filename,process,global){});require.define("/lib/runtime/core.js",function(require,module,exports,__dirname,__filename,process,global){var runtime=module.exports;runtime.error=function(){console.error.apply(console,arguments)};runtime.runDefers=function(defers,error,callback){var next=function(err){if(err){console.error(err&&err.stack)}var fn=defers.shift();if(typeof fn!=="function"){return callback(null)}try{fn(error,next)}catch(err){next(err)}};next()};runtime.ifCondition=function(){var groups=[];for(var i=0,len=arguments.length;i<len;i+=2){var g=[arguments[i],arguments[i+1]];groups.push(g)}var end=groups.pop();var lastCondition=false;var done=function(){if(typeof end[1]==="function"){if(lastCondition){end[1](null)}else{end[0](function(){end[1](null)})}}else{end[0](null)}};var next=function(){var g=groups.shift();if(!g){done()}else{lastCondition=g[0];if(g[0]){g[1](next)}else{next()}}};next()};runtime.conditionLoop=function(test,loop,done){var next=function(){if(test()){loop(next,done)}else{done()}};next()};runtime.forEachLoop=function(object,loop,done){var keys=Object.keys(object);var next=function(){if(keys.length>0){var k=keys.shift();loop(k,next,done)}else{done()}};next()};runtime.sleep=function(intval,callback){setTimeout(function(){callback(null,intval)},intval)};runtime.parseArguments=function(args){var ret={arguments:[]};ret.callback=args[args.length-1];for(var i=0,len=args.length-1;i<len;i++){ret.arguments.push(args[i])}return ret}});require.define("/lib/compiler/define.js",function(require,module,exports,__dirname,__filename,process,global){exports.TOKEN={BLANK:0,SYMBLE:1,NUMBER:2,STRING:4,NAME:8,KEYWORD:16,IDENTIFIER:32,COMMENT:64};exports.KEYWORD=["argument","var","let","throw","function","if","else","elseif","for","in","break","continue","return","await","sleep","defer","true","false","null","undefined","NaN"]});require.define("/lib/compiler/parser.js",function(require,module,exports,__dirname,__filename,process,global){var define=require("./define");var token=require("./token");var syntax=require("./syntax");var TOKEN=define.TOKEN;var showErrorLine=function(lines,i,col,err){var MAXCOL=50;console.log("[33m");console.log("\n");console.log(err);console.log("Line: "+(i+1)+", Column: "+(col+1));console.log("");var line=lines[i];if(line){if(col>MAXCOL){var m=col-MAXCOL;line=line.substr(m);col-=m}console.log(line);var line2="";for(var i=0;i<col;i++){if(line.charCodeAt(i)<=32){line2+=line[i]}else{line2+=" "}}console.log(line2+"^")}console.log("[39;49m");return line+"\n"+line2};exports.parse=function(source){var _throwError=function(line,column,error){var err=new Error(error);err.line=line;err.column=column;var lines=source.split(/\r?\n/gm);showErrorLine(lines,err.line,err.column,error);throw err};var throwError=function(line,column,error){_throwError(line,column,"SyntaxError: "+error)};var tokenList=token.parse(source);if(!Array.isArray(tokenList)){return _throwError(tokenList.line,tokenList.column,tokenList.error)}try{var js=syntax.parse(tokenList);return js}catch(err){var t=err.token;if(t){throwError(t.line,t.column,err.error)}else{throw err}}}});require.define("/lib/compiler/token.js",function(require,module,exports,__dirname,__filename,process,global){var define=require("./define");var TOKEN=define.TOKEN;var KEYWORD=define.KEYWORD;var _KEYWORD={};KEYWORD.forEach(function(w){_KEYWORD[w]=true});var STATUS={BLANK:0,SYMBLE:1,NUMBER:2,STRING:4,NAME:8,COMMENT_1:16,COMMENT_2:32};var CHAR={NUMBER_BEGIN:48,NUMBER_END:57,LOWER_BEGIN:97,LOWER_END:122,UPPER_BEGIN:65,UPPER_END:90,UNDERLINE:95,QUOTE_1:39,QUOTE_2:34,BACKSLASH:92,DOLLAR:36,STAR:42,FORWARDSLASH:47};var isNumber=function(c){return c>=CHAR.NUMBER_BEGIN&&c<=CHAR.NUMBER_END?true:false};var isLetter=function(c){return c>=CHAR.UPPER_BEGIN&&c<=CHAR.UPPER_END||c>=CHAR.LOWER_BEGIN&&c<=CHAR.LOWER_END||c===CHAR.UNDERLINE||c===CHAR.DOLLAR?true:false};var isBlank=function(c){return isNaN(c)||c<=32?true:false};var isQuote=function(c){return c===CHAR.QUOTE_1||c===CHAR.QUOTE_2?true:false};var isNewLine=function(c){return c===10||c===13?true:false};var isKeyword=function(w){return _KEYWORD[w]?true:false};exports._parse=function(source){source+=" ";var length=source.length;var curPos;var lastPos=0;var lineNum=0;var linePos=0;var curWord={line:0,column:0};var curStatus=STATUS.BLANK;var tokenList=[];var quoteBegin=false;var numberHasE=false;var numberHasDot=false;var numberHasSign=false;var prevCharIsBackslash=false;var startNewLine=function(){lineNum++;linePos=0};var nextChar=function(c){if(c===13){startNewLine()}else if(c===10){var pc=source.charCodeAt(curPos-1);if(pc===13){}else{startNewLine()}}else{linePos++}};var setStatus=function(s){curStatus=s;curWord={line:lineNum,column:linePos-1}};var pushToken=function(t){if(lastPos<curPos){var w=source.slice(lastPos,curPos);w=w.trim();var token={type:t,line:curWord.line,column:curWord.column,text:w};if(t===TOKEN.BLANK){if(token.column>0){token.text=" ";tokenList.push(token)}}else{if(t===TOKEN.STRING){token.text=token.text.replace(/\n/gm,"\\n").replace(/\r/gm,"\\r")}tokenList.push(token)}}lastPos=curPos;quoteBegin=false;numberHasE=false;numberHasDot=false;numberHasSign=false;prevCharIsBackslash=false};var checkNextChar=function(){var c=source.charCodeAt(curPos);nextChar(c);if(isNumber(c)){setStatus(STATUS.NUMBER)}else if(isLetter(c)){setStatus(STATUS.NAME)}else if(isBlank(c)){setStatus(STATUS.BLANK)}else{setStatus(STATUS.SYMBLE)}};var throwError=function(err){var err={error:"SyntaxError: "+err,line:lineNum,column:linePos-1};throw err};try{for(curPos=0;curPos<length;curPos++){var s=source[curPos];var c=source.charCodeAt(curPos);nextChar(c);switch(curStatus){case STATUS.BLANK:if(isNumber(c)){pushToken(TOKEN.BLANK);setStatus(STATUS.NUMBER)}else if(isLetter(c)){pushToken(TOKEN.BLANK);setStatus(STATUS.NAME)}else if(isQuote(c)){pushToken(TOKEN.BLANK);quoteBegin=c;setStatus(STATUS.STRING)}else if(isBlank(c)){}else{pushToken(TOKEN.BLANK);setStatus(STATUS.SYMBLE)}break;case STATUS.NUMBER:if(isNumber(c)){}else if(isLetter(c)){if(numberHasE===false&&(s==="e"||s==="E")){numberHasE=true;numberHasSign=false;numberHasDot=false}else{throwError("Unexpected token "+s)}}else if(isBlank(c)){pushToken(TOKEN.NUMBER);setStatus(STATUS.BLANK)}else{if(s==="."){if(numberHasDot){throwError("Unexpected token "+s)}else{numberHasDot=true}}else if(numberHasE&&s==="+"||s==="-"){if(numberHasSign){throwError("Unexpected token "+s)}else{numberHasSign=true}}else{pushToken(TOKEN.NUMBER);setStatus(STATUS.SYMBLE)}}break;case STATUS.NAME:if(isNumber(c)||isLetter(c)){}else if(isBlank(c)){pushToken(TOKEN.NAME);setStatus(STATUS.BLANK)}else{if(s==="_"){}else{pushToken(TOKEN.NAME);setStatus(STATUS.SYMBLE)}}break;case STATUS.SYMBLE:var pc=source.charCodeAt(curPos-1);if(c===CHAR.FORWARDSLASH&&pc===CHAR.FORWARDSLASH){curStatus=STATUS.COMMENT_1}else if(pc===CHAR.FORWARDSLASH&&c===CHAR.STAR){curStatus=STATUS.COMMENT_2}else{pushToken(TOKEN.SYMBLE);if(isNumber(c)){setStatus(STATUS.NUMBER)}else if(isLetter(c)){setStatus(STATUS.NAME)}else if(isBlank(c)){setStatus(STATUS.BLANK)}else if(isQuote(c)){quoteBegin=c;setStatus(STATUS.STRING)}else{setStatus(STATUS.SYMBLE)}}break;case STATUS.STRING:if(c===quoteBegin&&prevCharIsBackslash===false){curPos++;pushToken(TOKEN.STRING);checkNextChar()}else if(c===CHAR.BACKSLASH){prevCharIsBackslash=!prevCharIsBackslash}else if(prevCharIsBackslash){prevCharIsBackslash=false}break;case STATUS.COMMENT_1:if(isNewLine(c)||curPos>=length-2){curPos++;pushToken(TOKEN.COMMENT);checkNextChar()}break;case STATUS.COMMENT_2:if(c===CHAR.STAR){var nc=source.charCodeAt(curPos+1);if(nc===CHAR.FORWARDSLASH){curPos+=2;pushToken(TOKEN.COMMENT);nextChar();checkNextChar()}}break;default:throwError("Unexpected token ILLEGAL")}}if(curStatus!==STATUS.BLANK){throwError("Unexpected end of input")}else{return tokenList}}catch(err){return err}};exports.parse=function(source){var tokenList=exports._parse(source);if(!Array.isArray(tokenList)){return tokenList}for(var i=0;i<tokenList.length;i++){(function(w,i){switch(w.type){case TOKEN.NAME:if(isKeyword(w.text)){var prevT=tokenList[i-1];var nextT=tokenList[i+1];prevT=prevT&&prevT.type===TOKEN.SYMBLE?prevT.text:null;nextT=nextT&&nextT.type===TOKEN.SYMBLE?nextT.text:null;if(prevT==="."||nextT==="."){w.type=TOKEN.IDENTIFIER}else if((prevT==="{"||prevT===",")&&nextT===":"){w.type=TOKEN.IDENTIFIER}else{w.type=TOKEN.KEYWORD}}else{w.type=TOKEN.IDENTIFIER}break;case TOKEN.NUMBER:var prevT=tokenList[i-1];if(prevT&&prevT.type===TOKEN.SYMBLE&&prevT.text==="."){if(prevT.column+1===w.column&&prevT.line===w.line){var prevT2=tokenList[i-2];if(!prevT2||prevT2.type===TOKEN.SYMBLE){var newW={type:TOKEN.NUMBER,text:prevT.text+w.text,line:prevT.line,column:prevT.column};tokenList[i-1]=newW;tokenList.splice(i,1);i--}}}break;case TOKEN.SYMBLE:var nextT=tokenList[i+1];if(nextT&&w.line===nextT.line){if(w.text==="+"&&nextT.text==="+"||w.text==="-"&&nextT.text==="-"||w.text==="<"&&nextT.text==="<"||w.text===">"&&nextT.text===">"||w.text==="="&&nextT.text==="="||w.text===">"&&nextT.text==="="||w.text==="<"&&nextT.text==="="||w.text==="!"&&nextT.text==="="){var newW={type:TOKEN.SYMBLE,text:w.text+nextT.text,line:w.line,column:w.column};var nextT2=tokenList[i+2];if((w.text==="="||w.text==="!")&&nextT.text==="="&&nextT2&&nextT2.type===TOKEN.SYMBLE&&nextT2.text==="="){newW.text+=nextT2.text;tokenList.splice(i+1,2)}else{tokenList.splice(i+1,1)}tokenList[i]=newW}}}})(tokenList[i],i)}var list=["true","false","null","undefined","NaN"];tokenList.forEach(function(w){if(w.type===TOKEN.KEYWORD&&list.indexOf(w.text)!==-1){w.type=TOKEN.IDENTIFIER}});return tokenList}});require.define("/lib/compiler/syntax.js",function(require,module,exports,__dirname,__filename,process,global){var define=require("./define");var token=require("./token");var TOKEN=define.TOKEN;var syntax=module.exports;syntax.readLine=function(tokenList){if(tokenList[0]){var lineNum=tokenList[0].line;for(var i=1,len=tokenList.length;i<len;i++){if(tokenList[i].line!==lineNum){break}}return{line:tokenList.slice(0,i),next:tokenList.slice(i)}}else{return false}};syntax.throwWordError=function(t,e){if(!e){e="Unexpected token "+t.text}var err=new Error(e);err.error=e;err.token=t;console.error(err.stack);throw err};syntax.codePushLine=function(context,line){var spaces=syntax.getIndentSpace(context);context.code.push(spaces+line)};syntax.getIndentSpace=function(context){var spaces="";for(var i=0;i<context.indent;i++){spaces+="  "}return spaces};syntax.newContext=function(context){var ret={};for(var i in context){ret[i]=context[i]}ret.defers=[];ret.code=[];return ret};syntax.addReturnAtEnd=function(tokenList,isNested){var lastT=tokenList[tokenList.length-1];if(lastT){var tReturn={type:TOKEN.KEYWORD,line:lastT.line+1,column:0,text:"return"};if(isNested){tReturn.isNested=isNested}tokenList.push(tReturn)}return tokenList};syntax.parseCondition=function(tokenList){var lastT=tokenList[tokenList.length-1];if(!(lastT.type===TOKEN.SYMBLE&&lastT.text==="{")){return syntax.throwWordError(lastT)}tokenList.pop();var cond="";tokenList.forEach(function(t){if(t.type===TOKEN.SYMBLE&&t.text==="="){cond+=" == "}else{cond+=t.text}});return"("+cond+")"};syntax.parseMultiArgument=function(tokenList){var names=[];var lastPos=0;var push=function(i){if(lastPos<i){var text="";var brackets=[];tokenList.slice(lastPos,i).forEach(function(t){text+=t.text;if(t.type===TOKEN.SYMBLE){if(t.text==="["||t.text==="("){brackets.push(t.text)}else if(t.text==="]"||t.text===")"){var b=brackets.pop();if(!(t.text==="]"&&b==="["||t.text===")"&&b==="(")){return syntax.throwWordError(t,"brackets do not match")}}}});if(brackets.length>0){return syntax.throwWordError(t,"brackets do not match")}names.push(text);lastPos=i+1}};for(var i=0,len=tokenList.length;i<len;i++){var t=tokenList[i];if(t.type===TOKEN.SYMBLE){if(t.text===","){push(i)}else if(t.text==="="){push(i);break}}}return{names:names,next:tokenList.slice(i+1)}};syntax.getMultiArgumentsCode=function(names){var args=[];var init=[];names.forEach(function(n,i){args.push("$$_arg_"+i);init.push(n+" = $$_arg_"+i+";")});return{args:args,init:init}};syntax.parseMultiValue=function(tokenList){var names=[];var lastPos=0;var push=function(i){if(lastPos<i){var text="";var brackets=[];tokenList.slice(lastPos,i).forEach(function(t){text+=t.text;if(t.type===TOKEN.SYMBLE){if(t.text==="["||t.text==="("){brackets.push(t.text)}else if(t.text==="]"||t.text===")"){var b=brackets.pop();if(!(t.text==="]"&&b==="["||t.text===")"&&b==="(")){return syntax.throwWordError(t,"brackets do not match")}}}});if(brackets.length>0){return syntax.throwWordError(t,"brackets do not match")}names.push(text);lastPos=i+1}};for(var i=0,len=tokenList.length;i<len;i++){var t=tokenList[i];if(t.type===TOKEN.SYMBLE){if(t.text===","){push(i)}}}push(i);return names};syntax.noBlankToken=function(tokenList){var ret=[];tokenList.forEach(function(t){if(t.type!==TOKEN.BLANK){ret.push(t)}});return ret};syntax.wrap=function(context){if(context.vars.length>0){var varsCode="    var "+context.vars.join(", ")+";\n"}else{var varsCode=""}if(context.defers.length>0){var indent="    ";var defersCode=["\n"+indent+"/* defer function start */",indent+"var $$_defers = [];"];context.defers.forEach(function(fn){defersCode.push(indent+"$$_defers.push("+fn+");")});defersCode.push(indent+"var $$_oldCallback = $$_callback;");defersCode.push(indent+"$$_callback = $$_callback_global = function () {");defersCode.push(indent+"  var $$_args = arguments;");defersCode.push(indent+"  $$_runtime.runDefers($$_defers, $$_args[0], function (err) {");defersCode.push(indent+"    if (err) $$_runtime.error(err.stack);");defersCode.push(indent+"    $$_oldCallback.apply(null, $$_args);");defersCode.push(indent+"  });");defersCode.push(indent+"};");defersCode.push(indent+"/* defer function end */\n");defersCode=defersCode.join("\n")+"\n"}else{defersCode=""}var indent=syntax.getIndentSpace(context).substr(4);var code="(function ("+context.args.join(", ")+") {\n"+indent+'  "use strict";\n\n'+indent+"  /* function header start */\n"+indent+"  var $$_callback, $arguments;\n"+indent+'  if (arguments.length < 1 || typeof(arguments[arguments.length - 1]) !== "function") {\n'+indent+'    throw new Error("Need a callback parameter.");\n'+indent+"  } else {\n"+indent+"    $arguments = $$_runtime.parseArguments(arguments);\n"+indent+"    $$_callback = $arguments.callback;\n"+indent+"    $arguments = $arguments.arguments\n"+indent+"  }\n"+indent+"  var $$_callback_global = $$_callback;\n"+indent+"  /* function header end */\n\n"+indent+"  try {\n"+(varsCode?indent+varsCode:"")+(defersCode?indent+defersCode:"")+context.code.join("\n")+"\n"+indent+"  } catch (err) {\n"+indent+"    return $$_callback_global(err);\n"+indent+"  }\n"+indent+"})";return code};syntax.parse=function(tokenList,isNested){if(isNested){var context=tokenList}else{var context={args:[],vars:[],defers:[],tokenList:tokenList,code:[],indent:2}}if(!isNested){context.tokenList=syntax.addReturnAtEnd(context.tokenList)}var addLineNumber=function(t,msg){syntax.codePushLine(context,"/* LINE:"+(t.line+1)+" "+msg+" */")};for(var ret;ret=syntax.readLine(context.tokenList);){var line=ret.line;context.tokenList=ret.next;var firstT=line[0];var nextTs=line.slice(1);if(firstT.type===TOKEN.BLANK){}else if(firstT.type===TOKEN.KEYWORD){var needNextToken=function(){if(nextTs.length<1){return syntax.throwWordError(firstT,"Unexpected end of input")}};nextTs=syntax.noBlankToken(nextTs);switch(firstT.text){case"argument":needNextToken();syntax.parseArgument(context,nextTs);break;case"var":needNextToken();syntax.parseVar(context,nextTs);break;case"let":needNextToken();addLineNumber(firstT,"START");syntax.parseLet(context,nextTs);addLineNumber(firstT,"END");break;case"await":needNextToken();addLineNumber(firstT,"START");syntax.parseAwait(context,"",nextTs);addLineNumber(firstT,"END");break;case"sleep":needNextToken();addLineNumber(firstT,"START");syntax.parseSleep(context,nextTs);addLineNumber(firstT,"END");break;case"function":needNextToken();addLineNumber(firstT,"START");syntax.parseFunction(context,"",nextTs);addLineNumber(firstT,"END");break;case"return":addLineNumber(firstT,"START");syntax.parseReturn(context,nextTs,firstT.isNested);addLineNumber(firstT,"END");break;case"defer":needNextToken();syntax.parseDefer(context,nextTs);break;case"if":needNextToken();addLineNumber(firstT,"START");syntax.parseIf(context,nextTs);addLineNumber(firstT,"END");break;case"for":needNextToken();addLineNumber(firstT,"START");syntax.parseFor(context,nextTs);addLineNumber(firstT,"END");break;case"break":addLineNumber(firstT,"START");syntax.codePushLine(context,"return $$_break(null);");addLineNumber(firstT,"END");break;case"continue":addLineNumber(firstT,"START");syntax.codePushLine(context,"return $$_continue(null);");addLineNumber(firstT,"END");break;case"throw":addLineNumber(firstT,"START");syntax.parseThrow(context,nextTs);addLineNumber(firstT,"END");break;default:return syntax.throwWordError(firstT)}}else{addLineNumber(firstT,"START");syntax.parseExpression(context,"",line);addLineNumber(firstT,"END")}}if(!isNested){return syntax.wrap(context)}};syntax.parseNested=function(context,isReturn){var tokenList=context.tokenList;var ret;var body=[];var brace=0;while(ret=syntax.readLine(tokenList)){tokenList=ret.next;var line=syntax.noBlankToken(ret.line);var firstT=line[0];var lastT=line[line.length-1];if(firstT.type===TOKEN.SYMBLE&&firstT.text==="}"){brace--}else if(lastT.type===TOKEN.SYMBLE&&lastT.text==="{"){brace++}if(brace<0){if(line.length>1){tokenList=line.slice(1).concat(tokenList)}break}else{body=body.concat(line)}}if(isReturn){body=syntax.addReturnAtEnd(body,true)}context.tokenList=body;syntax.parse(context,true);context.tokenList=tokenList};syntax.parseArgument=function(context,tokenList){var isComma=false;tokenList.forEach(function(t){if(t.type===TOKEN.IDENTIFIER){isComma=false;context.args.push(t.text)}else if(t.type===TOKEN.SYMBLE&&t.text===","&&!isComma){isComma=true}else{syntax.throwWordError(t)}})};syntax.parseVar=function(context,tokenList){var isComma=false;tokenList.forEach(function(t){if(t.type===TOKEN.IDENTIFIER){isComma=false;context.vars.push(t.text)}else if(t.type===TOKEN.SYMBLE&&t.text===","&&!isComma){isComma=true}else{syntax.throwWordError(t)}})};syntax.parseLet=function(context,tokenList){if(tokenList.length<3){return syntax.throwWordError(tokenList[tokenList.length-1],"Unexpected end of input")}var ret=syntax.parseMultiArgument(tokenList);var names=ret.names;if(ret.next.length<1){return syntax.throwWordError(tokenList[tokenList.length-1],"Unexpected end of input")}else{tokenList=ret.next}if(tokenList[0].type===TOKEN.KEYWORD){if(tokenList[0].text==="await"){if(!tokenList[1]){return syntax.throwWordError(tokenList[0],"Unexpected end of input")}syntax.parseAwait(context,names,tokenList.slice(1))}else if(tokenList[0].text==="function"){if(!tokenList[1]){return syntax.throwWordError(tokenList[0],"Unexpected end of input")}if(names.length>1){return syntax.throwWordError(tokenList[0],"Not support tuple assignment")}syntax.parseFunction(context,names[0],tokenList.slice(1))}else{return syntax.throwWordError(tokenList[0])}}else{if(names.length>1){return syntax.throwWordError(tokenList[0],"Not support tuple assignment")}syntax.parseExpression(context,names[0],tokenList)}};syntax.parseExpression=function(context,name,tokenList){var code="";var isName=false;tokenList.forEach(function(t){if(t.type===TOKEN.IDENTIFIER||t.type===TOKEN.KEYWORD){code+=(isName?" ":"")+t.text;isName=true}else{code+=t.text;isName=false}});code=(name?name+" = ":"")+code.trim();syntax.codePushLine(context,code)};syntax.parseAwait=function(context,names,tokenList){var firstT=tokenList[0];if(tokenList.length===1&&firstT.type===TOKEN.NUMBER){return syntax.throwWordError(firstT)}else{if(tokenList[0].type!==TOKEN.IDENTIFIER){return syntax.throwWordError(tokenList[0])}var lastT=tokenList[tokenList.length-1];if(lastT.type===TOKEN.SYMBLE&&lastT.text===")"){var call="";tokenList.slice(0,tokenList.length-1).forEach(function(t){call+=t.text});var lastT2=tokenList[tokenList.length-2];if(!(lastT2&&lastT2.type===TOKEN.SYMBLE&&lastT2.text==="(")){call+=", "}}else{var call="";tokenList.forEach(function(t){call+=t.text});call+="("}}if(names.length>0){var code=syntax.getMultiArgumentsCode(names)}call+="function ("+(names.length>0?code.args.join(", "):"")+") {";syntax.codePushLine(context,call);context.indent++;if(names.length>0){code.init.forEach(function(line){syntax.codePushLine(context,line)})}syntax.parse(context,true);context.indent--;syntax.codePushLine(context,"});")};syntax.parseReturn=function(context,tokenList,isNested){var values=["null"];if(tokenList.length>0){values=values.concat(syntax.parseMultiValue(tokenList))}syntax.codePushLine(context,"return $$_callback"+(isNested?"":"_global")+"("+values.join(", ")+");")};syntax.parseDefer=function(context,tokenList){var lastT=tokenList[tokenList.length-1];var codeTop="function (error, $$_callback) {\n";var codeBottom="\n    }";if(lastT.type===TOKEN.SYMBLE){if(lastT.text===")"&&tokenList.length>=3){var call="";tokenList.forEach(function(t){call+=t.text});call="      "+call+";\n      return $$_callback(null);";context.defers.push(codeTop+call+codeBottom)}else if(lastT.text==="{"&&tokenList.length===1){var newContext=syntax.newContext(context);newContext.indent=3;syntax.parseNested(newContext,true);var code=newContext.code.join("\n");context.defers.push(codeTop+code+codeBottom);context.tokenList=newContext.tokenList}else{return syntax.throwWordError(lastT)}}else if(lastT.type===TOKEN.IDENTIFIER){var call="";tokenList.forEach(function(t){call+=t.text});call="      "+call+"();\n      return $$_callback(null);";context.defers.push(codeTop+call+codeBottom)}else{return syntax.throwWordError(lastT)}};syntax.parseIf=function(context,tokenList){var conditions=[];var parseBody=function(){var newContext=syntax.newContext(context);newContext.indent++;syntax.parseNested(newContext,true);context.tokenList=newContext.tokenList;var code=newContext.code.join("\n");code="function ($$_callback) {\n"+code+"\n"+syntax.getIndentSpace(context)+"}";return code};conditions.push(syntax.parseCondition(tokenList));conditions.push(parseBody());var nextW=context.tokenList[0];if(nextW&&nextW.type===TOKEN.KEYWORD&&(nextW.text==="else"||nextW.text==="elseif")){for(var ret;ret=syntax.readLine(context.tokenList);){var line=ret.line;context.tokenList=ret.next;var firstT=line[0];var nextTs=line.slice(1);if(firstT.type===TOKEN.KEYWORD){if(firstT.text==="elseif"){conditions.push(syntax.parseCondition(nextTs));conditions.push(parseBody())}else if(firstT.text==="else"){conditions.push(parseBody())}else{context.tokenList=line.concat(context.tokenList);break}}else{context.tokenList=line.concat(context.tokenList);break}}}var newContext=syntax.newContext(context);newContext.indent++;syntax.parseNested(newContext);context.tokenList=newContext.tokenList;var nextCode=newContext.code.join("\n");var code="$$_runtime.ifCondition("+conditions.join(", ")+", function () {\n"+nextCode+"\n"+syntax.getIndentSpace(context)+"});";syntax.codePushLine(context,code)};syntax.parseFor=function(context,tokenList){var parseNext=function(){var newContext=syntax.newContext(context);
newContext.indent++;syntax.parseNested(newContext);context.tokenList=newContext.tokenList;var nextCode=newContext.code.join("\n");return nextCode};if(tokenList.length>=3&&tokenList[1].type===TOKEN.KEYWORD&&tokenList[1].text==="in"){if(tokenList[0].type!==TOKEN.IDENTIFIER){return syntax.throwWordError(tokenList[0])}var keyName=tokenList[0].text;var objName="";tokenList.slice(2,tokenList.length-1).forEach(function(t){objName+=t.text});var newContext=syntax.newContext(context);newContext.indent++;syntax.parseNested(newContext,true);context.tokenList=newContext.tokenList;var bodyCode=newContext.code.join("\n");var indent=syntax.getIndentSpace(context);var code="$$_runtime.forEachLoop("+objName+", function ("+keyName+", $$_continue, $$_break) {\n"+indent+"  var $$_callback = $$_continue;\n"+bodyCode+"\n"+indent+"}, function () {\n"+parseNext()+"\n"+indent+"});";syntax.codePushLine(context,code)}else{if(tokenList.length===1&&tokenList[0].type===TOKEN.SYMBLE&&tokenList[0].text==="{"){var condition="true"}else{var condition=syntax.parseCondition(tokenList)}var newContext=syntax.newContext(context);newContext.indent++;syntax.parseNested(newContext,true);context.tokenList=newContext.tokenList;var bodyCode=newContext.code.join("\n");var indent=syntax.getIndentSpace(context);var code="$$_runtime.conditionLoop(function () {\n"+indent+"  return "+condition+";\n"+indent+"}, function ($$_continue, $$_break) {\n"+indent+"  var $$_callback = $$_continue;\n"+bodyCode+"\n"+indent+"}, function () {\n"+parseNext()+"\n"+indent+"});";syntax.codePushLine(context,code)}};syntax.parseThrow=function(context,tokenList){if(tokenList.length<1){syntax.codePushLine(context,"return $$_callback_global(new Error());")}else{syntax.parseExpression(context,"var $$_err",tokenList);syntax.codePushLine(context,"return $$_callback_global($$_err);")}};syntax.parseFunction=function(context,name,tokenList){var lastT=tokenList[tokenList.length-1];if(!(lastT.type===TOKEN.SYMBLE&&lastT.text==="{")){return syntax.throwWordError(lastT)}var argNames=[];if(tokenList.length===1){}else{var argTokens=tokenList.slice(0,tokenList.length-1);var firstT=argTokens[0];var lastT=argTokens[argTokens.length-1];if(!(firstT.type===TOKEN.SYMBLE&&firstT.text==="(")){return syntax.throwWordError(firstT)}if(!(lastT.type===TOKEN.SYMBLE&&lastT.text===")")){return syntax.throwWordError(firstT)}var isComma=true;argTokens.slice(1,argTokens.length-1).forEach(function(t){if(isComma&&t.type===TOKEN.IDENTIFIER){argNames.push(t.text);isComma=false}else if(!isComma&&t.type===TOKEN.SYMBLE&&t.text===","){isComma=true}else{return syntax.throwWordError(t)}})}var newContext=syntax.newContext(context);newContext.vars=[];newContext.indent+=2;syntax.parseNested(newContext,true);newContext.args=argNames;var body=syntax.wrap(newContext);syntax.codePushLine(context,"");var code=(name?name+" = ":"")+body+";";syntax.codePushLine(context,code);syntax.codePushLine(context,"");context.tokenList=newContext.tokenList};syntax.parseSleep=function(context,tokenList){var lastT=tokenList[tokenList.length-1];tokenList.push({type:TOKEN.SYMBLE,text:";",line:lastT.line,column:lastT.column+lastT.text.length+1});syntax.parseExpression(context,"var $$_sleep_ms",tokenList);var code="$$_runtime.sleep($$_sleep_ms, function ($$_err) {";syntax.codePushLine(context,code);context.indent++;syntax.parse(context,true);context.indent--;syntax.codePushLine(context,"});")}});require.define("/index.js",function(require,module,exports,__dirname,__filename,process,global){module.exports=require("./lib")});require("/index.js")})();